---
import Layout from '../../layouts/Layout.astro';
import TopNav from '../../components/TopNav.astro';
---

<Layout title="Results - Telescope">
  <TopNav active="results" />
  <section class="data-content">
    <h1>Results</h1>
    <h2>View test results</h2>
    <div id="results-container">
      <p>Loading results...</p>
    </div>
  </section>
</Layout>

<script>
  async function loadResults() {
    try {
      const response = await fetch('/api/results');
      if (!response.ok) throw new Error('Failed to load results');
      const results = await response.json();
      
      const container = document.getElementById('results-container');
      if (!container) return;
      if (results.length === 0) {
        container.innerHTML = '<p>No results available.</p>';
        return;
      }
      
      if (results.length === 0) {
        container.innerHTML = '<p>No results available.</p>';
        return;
      }
      
      container.innerHTML = `
        <div class="results-grid">
          ${results.map((result: any) => {
            const date = result.date 
              ? new Date(result.date).toLocaleString() 
              : (result.timestamp ? new Date(result.timestamp).toLocaleString() : 'N/A');
            
            return `
            <div class="result-card">
              <h3>${escapeHtml(result.testId || 'Unknown')}</h3>
              <div class="result-details">
                <div class="result-detail-item">
                  <span class="result-label">URL:</span>
                  <span class="result-value" title="${escapeHtml(result.url || 'N/A')}">${escapeHtml(result.url || 'N/A')}</span>
                </div>
                <div class="result-detail-item">
                  <span class="result-label">Date:</span>
                  <span class="result-value">${escapeHtml(date)}</span>
                </div>
                ${result.browser ? `
                <div class="result-detail-item">
                  <span class="result-label">Browser:</span>
                  <span class="result-value">${escapeHtml(result.browser)}</span>
                </div>
                ` : ''}
                ${!!!result.status ? `
                <div class="result-detail-item">
                  <span class="result-label">Status:</span>
                  <span class="result-value">${getStatusLabel(result.status)}</span>
                </div>
                ` : ''}
              </div>
              <div class="result-actions">
                <a href="/data/overview/${result.testId}" class="button button-primary">View Details</a>
              </div>
            </div>
          `;
          }).join('')}
        </div>
      `;
    } catch (error) {
      console.error('Error loading results:', error);
      document.getElementById('results-container')!.innerHTML = 
        '<p style="color: rgba(255, 100, 100, 0.92);">Error loading results.</p>';
    }
  }
  
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function getStatusLabel(status: number): string {
    switch (status) {
      case 0: return 'Pending';
      case 1: return 'Running';
      case 2: return 'Completed';
      case 3: return 'Aborted';
      case 4: return 'Failed';
      case 5: return 'Timed Out';
      case 6: return 'Cancelled';
      default: return 'Unknown';
    }
  }
  loadResults();
</script>
