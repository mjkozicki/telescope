---
import Layout from '../../../layouts/Layout.astro';
import TopNav from '../../../components/TopNav.astro';
import DataNav from '../../../components/DataNav.astro';

const { testId } = Astro.params;

export const prerender = false;
---

<Layout title={`Config - ${testId} - Telescope`}>
  <TopNav inactive="results" />
  <DataNav active="config" testId={testId} />
  <section class="data-content">
    <h1>Configuration</h1>
    <h2>View the test configuration.</h2>
    <div id="config-container">
      <p>Loading configuration...</p>
    </div>
  </section>
</Layout>

<script>
  const testId = window.location.pathname.split('/').pop();
  
  async function loadConfig() {
    try {
      const config = await fetch(`/api/results/${testId}/config.json`).then(r => r.ok ? r.json() : null);
      
      const container = document.getElementById('config-container');
      if (!config) {
        container!.innerHTML = '<p>No configuration available for this test.</p>';
        return;
      }
      
      container!.innerHTML = `
        <div class="overview-section">
          <h3>Test Configuration</h3>
          <div class="config-details">
            ${Object.entries(config).map(([key, value]) => `
              <div class="config-row">
                <div class="config-key">${escapeHtml(key)}</div>
                <div class="config-value">${formatValue(value)}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    } catch (error) {
      console.error('Error loading config:', error);
      document.getElementById('config-container')!.innerHTML = 
        '<p style="color: rgba(255, 100, 100, 0.92);">Error loading configuration.</p>';
    }
  }
  
  function formatValue(value: any): string {
    if (value === null || value === undefined) return 'N/A';
    if (typeof value === 'object') {
      return '<pre>' + escapeHtml(JSON.stringify(value, null, 2)) + '</pre>';
    }
    return escapeHtml(String(value));
  }
  
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  loadConfig();
</script>

<style>
  .config-details {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 16px;
  }

  .config-row {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 16px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 6px;
    border-left: 3px solid rgba(125, 211, 252, 0.5);
  }

  .config-key {
    font-weight: 600;
    color: rgba(255, 255, 255, 0.72);
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .config-value {
    color: rgba(255, 255, 255, 0.85);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    font-size: 13px;
    word-break: break-word;
  }

  .config-value pre {
    margin: 0;
    padding: 8px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    overflow-x: auto;
  }
</style>
