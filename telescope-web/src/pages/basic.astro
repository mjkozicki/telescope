---
import Layout from '../layouts/Layout.astro';
import TopNav from '../components/TopNav.astro';

export const prerender = false;
---

<Layout title="Basic Test - Telescope">
  <TopNav active="basic" />
  <section class="data-content">
    <h1>Basic Test</h1>
    <h2>Run a simple performance test with basic settings.</h2>
    
    <div class="overview-section">
      <form id="basic-test-form" class="test-form">
        <input type="hidden" name="source" value="basic" />
        <div class="form-group">
          <label for="url"><span>URL</span><span class="required">*</span></label>
          <input  type="url"  id="url"  name="url"  required  placeholder="https://example.com" value="" />       
        </div>

        <div class="form-group">
          <label for="browser"><span>Browser</span><span class="required">*</span></label>
          <select id="browser" name="browser">
            <option value="chrome" selected>Chrome</option>
            <option value="chrome-beta">Chrome Beta</option>
            <option value="canary">Chrome Canary</option>
            <option value="edge">Edge</option>
            <option value="firefox">Firefox</option>
            <option value="safari">Safari</option>
          </select>
        </div>

        <div class="form-group">
          <label for="name"><span>Name (optional)</span></label>
          <input type="text" id="name" name="name" />
        </div>

        <div class="form-group">
          <label for="description"><span>Description (optional)</span></label>
          <textarea rows="3" id="description" name="description"></textarea>
        </div>

      <div class="form-actions">
          <button type="submit" class="button button-primary">Run Test</button>
          <button type="reset" class="button button-secondary">Reset</button>
        </div>
      </form>
    </div>

    <div id="test-status" class="test-status" style="display: none;">
      <div class="status-message"></div>
    </div>
  </section>
</Layout>

<script>

  const form = document.getElementById('basic-test-form') as HTMLFormElement;
  const statusDiv = document.getElementById('test-status') as HTMLElement;
  const statusMessage = statusDiv.querySelector('.status-message') as HTMLElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    const formData = new FormData(form);
    const data: Record<string, any> = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    statusDiv.style.display = 'block';
    statusMessage.textContent = 'Starting test...';
    statusDiv.className = 'test-status status-running';

    try {
      const response = await fetch('/api/test/run', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Failed to start test');
      }

      const result = await response.json();
      
      if (result.testId) {
        statusMessage.innerHTML = `
          <p>Test started successfully!</p>
          <p>Test ID: <strong>${escapeHtml(result.testId)}</strong></p>
          <p><a href="/data/overview/${result.testId}" class="button button-primary">View Results</a></p>
        `;
        statusDiv.className = 'test-status status-success';
      } else {
        throw new Error('No test ID returned');
      }
    } catch (error) {
      statusMessage.innerHTML = `
        <p>Error: ${escapeHtml((error as Error).message)}</p>
      `;
      statusDiv.className = 'test-status status-error';
    }
  });

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>

<style>
  .test-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 16px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .form-group label {
    font-size: 14px;
    color: rgba(0, 0, 0, 0.78);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .required {
    color: rgba(239, 68, 68, 0.9);
  }

  .form-group input[type="text"],
  .form-group input[type="url"],
  .form-group input[type="number"],
  .form-group select,
  .form-group textarea {
    font: inherit;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: #fefefe;
    color: var(--text);
    font-size: 14px;
  }

  .form-group textarea {
    resize: vertical;
    font-family: inherit;
    background: #fefefe;
  }

  .form-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .form-group label:has(input[type="checkbox"]) {
    flex-direction: row;
    align-items: center;
    cursor: pointer;
  }

  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 8px;
  }

  .button {
    padding: 10px 20px;
    border-radius: 12px;
    border: none;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .button-primary {
    background: var(--brand);
    color: white;
  }

  .button-primary:hover {
    opacity: 0.9;
  }

  .button-secondary {
    background: rgba(0, 0, 0, 0.05);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .button-secondary:hover {
    background: rgba(0, 0, 0, 0.08);
  }

  .test-status {
    margin-top: 24px;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid rgba(0, 0, 0, 0.12);
  }

  .status-running {
    background: rgba(251, 191, 36, 0.1);
    border-color: var(--color-warning);
  }

  .status-success {
    background: rgba(74, 222, 128, 0.1);
    border-color: var(--color-success);
  }

  .status-error {
    background: rgba(239, 68, 68, 0.1);
    border-color: var(--color-danger);
  }

  .status-message p {
    margin: 8px 0;
  }

  .status-message a {
    display: inline-block;
    margin-top: 8px;
  }
</style>
