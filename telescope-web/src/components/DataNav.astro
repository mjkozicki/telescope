---
export interface Props {
  active?: string;
  testId?: string;
}

const { active, testId } = Astro.props;
---

<data-nav active={active} test-id={testId}></data-nav>

<script>
  class DataNav extends HTMLElement {
    private _testId: string = '';
    private _currentPage: string = '';

    static get observedAttributes() {
      return ['test-id', 'current-page', 'active'];
    }

    get testId(): string {
      return this._testId;
    }

    set testId(value: string) {
      this._testId = value;
      this.setAttribute('test-id', value);
    }

    get currentPage(): string {
      return this._currentPage;
    }

    set currentPage(value: string) {
      this._currentPage = value;
      this.setAttribute('current-page', value);
    }

    attributeChangedCallback(name: string, oldValue: string, newValue: string) {
      if (oldValue !== newValue) {
        if (name === 'test-id') {
          this._testId = newValue || '';
        } else if (name === 'current-page' || name === 'active') {
          this._currentPage = newValue || '';
        }
        this.render();
      }
    }

    connectedCallback() {
      const activeAttr = this.getAttribute('active') || this.getAttribute('current-page');
      if (activeAttr) {
        this._currentPage = activeAttr;
      } else {
        const pathParts = window.location.pathname.split('/').filter(Boolean);
        const dataIndex = pathParts.indexOf('data');
        if (dataIndex !== -1 && pathParts[dataIndex + 1]) {
          this._currentPage = pathParts[dataIndex + 1];
        }
      }
      
      const testIdAttr = this.getAttribute('test-id');
      if (testIdAttr) {
        this._testId = testIdAttr;
      } else {
        const pathParts = window.location.pathname.split('/').filter(Boolean);
        const pageNames = ['overview', 'filmstrip-video', 'metrics', 'waterfall', 'console', 'resources', 'bottlenecks', 'config'];
        const dataIndex = pathParts.indexOf('data');
        
        if (dataIndex !== -1 && pathParts[dataIndex + 2]) {
          const possibleTestId = pathParts[dataIndex + 2];
          if (possibleTestId && !pageNames.includes(possibleTestId)) {
            this._testId = possibleTestId;
          }
        }
      }
      
      this.render();
    }

    private render() {
      const navItems = [
        { name: 'overview', label: 'Overview' },
        { name: 'filmstrip-video', label: 'Filmstrip & Video' },
        { name: 'metrics', label: 'Metrics' },
        { name: 'waterfall', label: 'Waterfall' },
        { name: 'console', label: 'Console' },
        { name: 'resources', label: 'Resources' },
        { name: 'bottlenecks', label: 'Bottlenecks' },
        { name: 'config', label: 'Config' },
      ];

      const basePath = this._testId ? `/data` : '/data';
      const testIdPath = this._testId ? `/${this._testId}` : '';

      this.innerHTML = `
        <nav class="data-nav">
          <div class="tabs" part="tabs">
            ${navItems
              .map(
                (item) => `
            <a class="tab ${this._currentPage === item.name ? 'active' : ''}" 
               href="${basePath}/${item.name}${testIdPath}">
              ${item.label}
            </a>
          `
              )
              .join('')}
          </div>
        </nav>
      `;
    }
  }

  customElements.define('data-nav', DataNav);
</script>
