{"version":3,"file":"_server.ts-DoLH5j0t.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/upload/_server.ts.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { existsSync, mkdirSync, writeFileSync, readFileSync } from \"fs\";\nimport { join } from \"path\";\nimport AdmZip from \"adm-zip\";\nconst POST = async ({ request }) => {\n  console.log(\"upload endpoint\");\n  try {\n    const formData = await request.formData();\n    const file = formData.get(\"file\");\n    if (!file) {\n      return json({ error: \"No file uploaded\" }, { status: 400 });\n    }\n    const filename = file.name;\n    const testId = filename.replace(/\\.zip$/i, \"\");\n    if (!testId) {\n      return json({ error: \"Invalid filename\" }, { status: 400 });\n    }\n    const resultsDir = join(process.cwd(), \"static\", \"results\");\n    const testDir = join(resultsDir, testId);\n    if (existsSync(testDir)) {\n      return json(\n        {\n          error: \"Directory already exists\",\n          testId\n        },\n        { status: 409 }\n      );\n    }\n    mkdirSync(testDir, { recursive: true });\n    const arrayBuffer = await file.arrayBuffer();\n    const buffer = Buffer.from(arrayBuffer);\n    const zip = new AdmZip(buffer);\n    zip.extractAllTo(testDir, true);\n    let manifest = null;\n    const manifestPath = join(testDir, \"manifest.json\");\n    if (!existsSync(manifestPath)) {\n      const entries = zip.getEntries();\n      manifest = {\n        testId,\n        uploadedAt: (/* @__PURE__ */ new Date()).toISOString(),\n        files: entries.map((entry) => ({\n          name: entry.entryName,\n          size: entry.header.size\n        }))\n      };\n      writeFileSync(manifestPath, JSON.stringify(manifest, null, 2), \"utf-8\");\n    } else {\n      manifest = JSON.parse(readFileSync(manifestPath, \"utf-8\"));\n    }\n    return json({\n      success: true,\n      testId,\n      manifest,\n      url: `/results/${testId}/overview`\n    });\n  } catch (error) {\n    console.error(\"Upload error:\", error);\n    return json(\n      {\n        error: \"Internal server error\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      },\n      { status: 500 }\n    );\n  }\n};\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}